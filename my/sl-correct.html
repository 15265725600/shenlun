<!DOCTYPE html>
<html class="height">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>联创世华</title>
		<link rel="stylesheet" href="../assets/css/amazeui.css">
		<link rel="stylesheet" href="../assets/css/common.css" />
		<link rel="stylesheet" href="../assets/css/style.css">

	</head>

	<body class="height">
		<header data-am-widget="header" class="am-header am-header-fixed index-header">
			<div class="am-header-left am-header-nav">
				<a href="javascript:history.back()" class="">
					<i class="arrow-left"></i>
				</a>
			</div>
			<h1 class="am-header-title">
		        <a href="javascript:;" class="">
		           申论批改
		        </a>
		    </h1>
			<div class="am-header-right am-header-nav">
				<a href="javascript:;" class="">
					<i class="compltet" style="color:#fff">完成</i>
				</a>
			</div>
		</header>
		<div class="sl-container">
			<div class="detail-wrapper clearfix" style="min-height: 80%;">
				<div class="detail-main">
					<div class="text">
						<textarea name="" rows="4" cols="" class="message" placeholder="请输入文字"></textarea>
					</div>
					<div class="ar-addimg">
						<div class="infor">
							已添加<span class="have"></span>张，还可添加<span class="addhave"></span>张
						</div>
						<div class="upload-wrap">
							<ul class="upload am-cf">
								<li class="upload-btn">
									<img src="../assets/i/add-img.png">
									<input type="file" class="j-file-cert" name="temp_file" />
								</li>
							</ul>
						</div>
					</div>
					<div class="voice-word">
						<div class="voice">
							1分50秒
						</div>
					</div>
				</div>
			</div>
			<div class="voice-wrapper">
				<div class="voice1">
					<div class="voice2">按住</br>说话</div>
				</div>
			</div>

		</div>
	</body>
	<script type="text/javascript" src="../assets/js/jquery.min.js"></script>
	<script type="text/javascript" src="../assets/js/amazeui.js"></script>
	<script type="text/javascript" src="../assets/js/template.js"></script>
	<script type="text/javascript" src="../assets/js/exif.min.js" ></script>
	<script type="text/javascript" src="../assets/js/common.js"></script>
	<script type="text/javascript" src="../assets/js/iscroll.js"></script>
	<script type="text/javascript">
		$(function() {
			var id = GetQueryString('id');
			var token = getCookie('token');
			var imgArr = [];
			var para = window.location.search;
			//上传图片
			var count = 0;
			$('.j-file-cert').on('change', function(e) {
				count++;
				if(count < 5) {
					var that = $(this);
					if(!window.FileReader) return;

					e.stopPropagation();
					e.preventDefault();

					var file = e.target.files[0];
					var content = '';

					if(!file.type.match('image.*')) {
						alert('文件' + f.name + '不是图片')
						return;
					}

					var orientation;
					//EXIF js 可以读取图片的元信息 https://github.com/exif-js/exif-js
					EXIF.getData(file, function() {
						orientation = EXIF.getTag(this, 'Orientation');
					});

					var reader = new FileReader();

					reader.onload = function(e) {
						getImgData(this.result, orientation, function(data) {
							$.ajax({
								type: 'POST',
								url: reqUrl("web_file_upload_return_url"),
								data: {
									token: token,
									keytype: 3,
									img: data
								},
								dataType: 'JSON',
								xhrFields: {
									withCredentials: true
								},
								async: false,
								success: function(data) {
									imgArr.push(data.infor[0].item1);
									content = '<li>' +
										'<img class="j-image" src="' + data.infor[0].item1 + '">' +
										'<i class="icon-close"></i>' +
										'</li>'

									that.parent().before(content);
									//	删除上传图片
									$('.upload').on('click', '.icon-close', function() {
										$(this).parent().remove();
										var tue = $(this).siblings().attr('src');
										imgArr.removeByValue(tue);
										if(count > 0) {
											count--;
										}
										var length = $('.upload').children('li').length;
										console.log(length);
										$('.have').text(length - 1);
										$('.addhave').text(4 - $('.have').text());
									});
									var length = $('.upload').children('li').length;
									console.log(length);
									$('.have').text(length - 1);
									$('.addhave').text(4 - $('.have').text());

								}
							});
						});

					}
					reader.readAsDataURL(file);
				} else {
					mask('最多传4张图片');
					count = 4;
					return false;
				}

			});
			$('.compltet').click(function() {
				var message = $('.message').val();
				var imgString = imgArr.join(",");
				$.ajax({
					url: reqUrl('pigai_do'),
					type: 'post',
					dataType: 'json',
					data: {
						token: token,
						pigai_id: id,
						pigai:imgString,
						pigai_word:message
					},
					xhrFields: {
						withCredentials: true
					},
					success: function(data) {
						if(data.error_code == 200) {
							window.location.href = preUrl('log/login.html' + para + '&path=index/sl-correct.html');
						} else if(data.success) {
//							mask('ok')
							window.location.href = document.referrer;
						} else {
							mask(data.msg);
						}

					},
					error: function(e, request, settings) {
						alert(settings);
					}
				});

			})

			//删除数组中指定的一项
			Array.prototype.removeByValue = function(val) {
				for(var i = 0; i < this.length; i++) {
					if(this[i] == val) {
						this.splice(i, 1);
						break;
					}
				}
			}
		});
	</script>

</html>