<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>联创世华</title>
		<link rel="stylesheet" href="../assets/css/amazeui.css">
		<link rel="stylesheet" href="../assets/css/common.css" />
		<link rel="stylesheet" href="../assets/css/style.css">

	</head>

	<body>
		<header data-am-widget="header" class="am-header am-header-fixed index-header">
			<div class="am-header-left am-header-nav">
				<a href="javascript:history.back()" class="">
					<i class="arrow-left"></i>
				</a>
			</div>
			<h1 class="am-header-title">
		        <a href="javascript:;" class="">
		           整卷作答
		        </a>
		    </h1>
		</header>
		<div class="ar-container">
			<div class="ar-con">
				<script type="text/html" id="respon">
					<h1 class="ar-title">{{infor[0].title}}</h1>
					<div class="ar-content">
						<div class="ar-subject">
							<div class="title">
								<p>{{infor[0].question}}</p>
							</div>
							<div class="require">
								<p>
									{{infor[0].shuoming}}
								</p>
							</div>
							<div class="proposal">
								<span>*</span> 请在纸质答题卡上作答完成后拍照 上传，建议使用规范方格纸。
								<a href="view-data.html" class="look-data">查看资料</a>
							</div>
						</div>
					</div>
					<div class="line"></div>
					<div class="ar-addimg">
						<div class="infor">
							已添加<span class="have"></span>张，还可添加<span class="addhave"></span>张
						</div>
						<div class="upload-wrap">
							<ul class="upload am-cf" data-am-widget="gallery" data-am-gallery="{ pureview: true }">
								{{each infor[0].answer.split(',') as img index}}
								<li>
									<img src="{{img}}" alt="" />
									<i class="icon-close"></i>
								</li>
								{{/each}}
								<li class="upload-btn">
									<img src="../assets/i/add-img.png">
									<input type="file" class="j-file-cert" name="temp_file" />
								</li>
							</ul>
						</div>
						<div class="proposal">
							<span>*</span> 请在纸质答题卡上作答完成后拍照 上传，建议使用规范方格纸。
							<a href="javascript:;" class="look-data">上传图片</a>
						</div>
					</div>

				</script>
			</div>
			<div class="ar-next">
				<a href="javascript:;">进入下一题</a>
			</div>
		</div>

	</body>
	<script type="text/javascript" src="../assets/js/jquery.min.js"></script>
	<script type="text/javascript" src="../assets/js/amazeui.js"></script>
	<script type="text/javascript" src="../assets/js/template.js"></script>
	<script type="text/javascript" src="../assets/js/common.js"></script>
	<script type="text/javascript" src="../assets/js/exif.min.js"></script>
	<script type="text/javascript" src="../assets/js/iscroll.js"></script>
	<script type="text/javascript">
		$(function() {
			$('body').addClass('bg-color');
			var token = getCookie('token');
			var id = GetQueryString('id');
			var pid = GetQueryString('pid');
			var num = GetQueryString('num');
			var imgArr = []; //图片数组
			var answerID = ""; //获取答题id
			//获取试卷详情
			getDetail(id);

			function getDetail(ID) {
				$.ajax({
					url: reqUrl('yeartest_amend'),
					type: 'post',
					dataType: 'json',
					data: {
						token: token,
						id: ID
					},
					xhrFields: {
						withCredentials: true
					},
					success: function(data) {
						if(data.error_code == 100) {
							window.location.href = preUrl('log/login.html?path=index/correct-reapondence.html');
						} else if(data.success) {
							var respon = template('respon', data);
							$('.ar-con').html(respon);
							answerID = data.infor[0].answer_id;
							var answer = data.infor[0].answer;
							imgArr.push(answer);
							$('.upload').on('click', '.icon-close', function() {
								$(this).parent().remove();
								var tue = $(this).siblings().attr('src');
								imgArr.removeByValue(tue);
								if(count > 0) {
									count--;
								}
								var length = $('.upload').children('li').length;
								console.log(length);
								$('.have').text(length - 1);
								$('.addhave').text(4 - $('.have').text());
							});
							var count = 0;
							$('.j-file-cert').on('change', function(e) {
								count++;
								if(count < 5) {
									var that = $(this);
									if(!window.FileReader) return;

									e.stopPropagation();
									e.preventDefault();

									var file = e.target.files[0];
									var content = '';

									if(!file.type.match('image.*')) {
										alert('文件' + f.name + '不是图片')
										return;
									}

									var orientation;
									//EXIF js 可以读取图片的元信息 https://github.com/exif-js/exif-js
									EXIF.getData(file, function() {
										orientation = EXIF.getTag(this, 'Orientation');
									});

									var reader = new FileReader();

									reader.onload = function(e) {
										getImgData(this.result, orientation, function(data) {
											$.ajax({
												type: 'POST',
												url: reqUrl("web_file_upload_return_url"),
												data: {
													token: token,
													keytype: 2,
													img: data
												},
												dataType: 'JSON',
												xhrFields: {
													withCredentials: true
												},
												async: false,
												success: function(data) {
													imgArr.push(data.infor[0].item1);
													console.log(imgArr);
													content = '<li>' +
														'<img class="j-image" src="' + data.infor[0].item1 + '">' +
														'<i class="icon-close"></i>' +
														'</li>'

													that.parent().before(content);
													//	删除上传图片
													$('.upload').on('click', '.icon-close', function() {
														$(this).parent().remove();
														var tue = $(this).siblings().attr('src');
														imgArr.removeByValue(tue);
														if(count > 0) {
															count--;
														}
														var length = $('.upload').children('li').length;
														console.log(length);
														$('.have').text(length - 1);
														$('.addhave').text(4 - $('.have').text());
													});
													var length = $('.upload').children('li').length;
													console.log(length);
													$('.have').text(length - 1);
													$('.addhave').text(4 - $('.have').text());

												}
											});
										});

									}
									reader.readAsDataURL(file);
								} else {
									mask('最多传4张图片');
									count = 4;
									return false;
								}
							});
							$('.look-data').on('click', function() {
								var imgString = imgArr.join(",");
								$.ajax({
									url: reqUrl('yeartest_answer_amend'),
									type: 'post',
									dataType: 'json',
									data: {
										token: token,
										id: answerID,
										img: imgString
									},
									xhrFields: {
										withCredentials: true
									},
									success: function(data) {
										if(data.success) {
											mask('上传成功');
										} else {
											mask(data.msg);
										}

									},
									error: function(e, request, settings) {
										alert(settings);
									}
								});
							});

						} else {
							mask(data.msg);
						}

					},
					error: function(e, request, settings) {
						alert(settings);
					}
				});
			}
			//点击下一题
			$('.ar-next a').on('click', function(e) {
				e.stopPropagation();
				e.preventDefault();
				id++;
				if(id == num) {
					$(this).html('结束作答');
					$(this).click(function(){
						window.location.href = document.referrer;
					})
					 getDetail(id);
				}
								
			})

			//删除数组中指定的一项
			Array.prototype.removeByValue = function(val) {
				for(var i = 0; i < this.length; i++) {
					if(this[i] == val) {
						this.splice(i, 1);
						break;
					}
				}
			}

		});
	</script>

</html>